<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WebRTC + Audio Recording</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f5f5f5;
      padding: 20px;
    }

    button {
      padding: 8px 16px;
      margin: 5px;
      font-size: 14px;
    }

    #media {
      max-width: 720px;
      width: 100%;
      padding: 16px;
      margin-top: 20px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    video {
      width: 100%;
      max-width: 640px;
      border-radius: 8px;
    }

    textarea {
      width: 600px;
      height: 60px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>ğŸ¥ æ‘„åƒå¤´ + ğŸ¤ è¯­éŸ³å‘é€</h2>

  <div class="option">
    <input id="use-stun" type="checkbox"/>
    <label for="use-stun">Use STUN server</label>
  </div>

  <div>
    <button id="start" onclick="start()">Start Camera</button>
    <button id="stop" style="display: none" onclick="stop()">Stop Camera</button>
  </div>

  <form id="echo-form">
    <div style="display: flex; flex-direction: column; align-items: flex-start;">
      <label for="message">è¾“å…¥æ–‡æœ¬ï¼š</label>
      <textarea id="message">ä»Šå¤©å¤©æ°”</textarea>
      <button type="submit">å‘é€æ–‡æœ¬</button>
    </div>
  
    <div style="display: flex; flex-direction: column; align-items: flex-start;">
      <label for="ai-response">AI æ–‡æœ¬ï¼š</label>
      <textarea id="ai-response" readonly style="background-color: #eee;"></textarea>
    </div>
  </form>

  <div>
    <button id="start-record">ğŸ¤ å¼€å§‹å½•éŸ³</button>
    <button id="stop-record" disabled>â¹ï¸ åœæ­¢å¹¶å‘é€</button>
  </div>

  <div id="media">
    <h3>åª’ä½“åŒºåŸŸ</h3>
    <video id="video" autoplay playsinline></video>
    <audio id="audio" autoplay></audio>
  </div>
  <script src="client.js"></script>
  <script src="http://cdn.sockjs.org/sockjs-0.3.4.js"></script>
  <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-2.1.1.min.js"></script>
<script>
  let ws;
  let audioContext;
  let mediaStream;
  let processor;
  let audioData = [];

  $(document).ready(function () {
    const host = window.location.hostname;
    ws = new WebSocket("ws://" + host + ":8765");

    ws.onopen = function () {
      console.log('âœ… WebSocket å·²è¿æ¥');
    };

    ws.onmessage = function (e) {
      console.log('ğŸ“© æ”¶åˆ°æ¶ˆæ¯: ' + e.data);
      document.getElementById("ai-response").value = e.data;
    };

    ws.onclose = function () {
      console.log('âŒ WebSocket å…³é—­');
    };

    $('#echo-form').on('submit', function (e) {
      e.preventDefault();
      const message = $('#message').val();
      console.log('ğŸ“¤ å‘é€æ–‡æœ¬: ' + message);
      ws.send(message);
      $('#message').val('');
    });
  });

  // å¼€å§‹å½•éŸ³
  document.getElementById("start-record").onclick = async () => {
    audioData = [];
    audioContext = new AudioContext({ sampleRate: 16000 }); // é€‚é…åç«¯
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    const source = audioContext.createMediaStreamSource(mediaStream);

    processor = audioContext.createScriptProcessor(4096, 1, 1);
    source.connect(processor);
    processor.connect(audioContext.destination);

    processor.onaudioprocess = e => {
      const input = e.inputBuffer.getChannelData(0);
      audioData.push(new Float32Array(input));
    };

    console.log("ğŸ™ï¸ å¼€å§‹å½•éŸ³");
    document.getElementById("start-record").disabled = true;
    document.getElementById("stop-record").disabled = false;
  };

  // åœæ­¢å½•éŸ³å¹¶å‘é€ä¸º WAV Blob
  document.getElementById("stop-record").onclick = () => {
    processor.disconnect();
    mediaStream.getTracks().forEach(track => track.stop());

    const blob = encodeWAV(audioData, audioContext.sampleRate);
    sendAudioBlob(blob);

    document.getElementById("start-record").disabled = false;
    document.getElementById("stop-record").disabled = true;
    console.log("ğŸ›‘ åœæ­¢å½•éŸ³");
  };

  // å‘é€éŸ³é¢‘ Blob
  function sendAudioBlob(blob) {
    const reader = new FileReader();
    reader.onloadend = () => {
      const arrayBuffer = reader.result;
      ws.send(arrayBuffer);
      console.log("ğŸ“¤ å·²å‘é€ WAV éŸ³é¢‘ï¼Œå¤§å°:", blob.size);
    };
    reader.readAsArrayBuffer(blob);
  }

  // æ‰‹åŠ¨å°è£… WAV
  function encodeWAV(samples, sampleRate = 16000) {
    const merged = flattenArray(samples);
    const buffer = new ArrayBuffer(44 + merged.length * 2);
    const view = new DataView(buffer);

    // WAV header
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + merged.length * 2, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true); // Subchunk1Size
    view.setUint16(20, 1, true);  // PCM
    view.setUint16(22, 1, true);  // Mono
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true); // ByteRate
    view.setUint16(32, 2, true); // BlockAlign
    view.setUint16(34, 16, true); // BitsPerSample
    writeString(view, 36, 'data');
    view.setUint32(40, merged.length * 2, true);

    // PCM samples
    floatTo16BitPCM(view, 44, merged);

    return new Blob([view], { type: 'audio/wav' });
  }

  function flattenArray(chunks) {
    const length = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
    const result = new Float32Array(length);
    let offset = 0;
    chunks.forEach(chunk => {
      result.set(chunk, offset);
      offset += chunk.length;
    });
    return result;
  }

  function floatTo16BitPCM(view, offset, input) {
    for (let i = 0; i < input.length; i++) {
      const s = Math.max(-1, Math.min(1, input[i]));
      view.setInt16(offset + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }
  }

  function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  }
</script>
