<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>语音识别</title>
 
	</head>
	<body style="margin-left: 3%">
		<script src="recorder-core.js" charset="UTF-8"></script>
		<script src="wav.js" charset="UTF-8"></script>
		<script src="pcm.js" charset="UTF-8"></script>
		
		

        <h1>FunASR Demo</h1>
						<h3>这里是FunASR开源项目体验demo，集成了VAD、ASR与标点等工业级别的模型，支持长音频离线文件转写，实时语音识别等，开源项目地址：https://github.com/alibaba-damo-academy/FunASR</h3>

		<div class="div_class_topArea">

			<div class="div_class_recordControl">
				asr服务器地址(必填):
				<br>
				<input id="wssip" type="text" onchange="addresschange()" style=" width: 100%;height:100%" value="wss://10.0.102.247:10082/"/>
				<br>
				<a id="wsslink"  href="#" onclick="window.open('https://127.0.0.1:10095/', '_blank')"><div id="info_wslink">点此处手工授权wss://10.0.102.247:10082/</div></a>
				<br>
			<br>  
			<div  style="border:2px solid #ccc;">
				选择录音模式:<br/>
    
        <label><input name="recoder_mode" onclick="on_recoder_mode_change()" type="radio" value="mic" checked="true"/>麦克风 </label>&nbsp;&nbsp;
        <!-- <label><input name="recoder_mode" onclick="on_recoder_mode_change()" type="radio" value="file" />文件 </label>  -->

				</div>
				
				<br>
				 <div id="mic_mode_div" style="border:2px solid #ccc;display:block;">
				选择asr模型模式:<br/>
    
      <label><input name="asr_mode" type="radio" value="2pass" checked="true"/>2pass </label>&nbsp;&nbsp;
      <label><input name="asr_mode" type="radio" value="online" />online </label>&nbsp;&nbsp;
      <label><input name="asr_mode" type="radio" value="offline" />offline </label>

				</div>
				
				<div id="rec_mode_div" style="border:2px solid #ccc;display:none;">
		 
    
		          <input type="file" id="upfile">

				</div>
				<br>
		        <div  style="border:2px solid #ccc;">
					热词设置(一行一个关键字，空格隔开权重,如"阿里巴巴 20")：
					<br>
	
	
					<textarea rows="3"  id="varHot"  style=" width: 100%;height:100%" >阿里巴巴 20&#13;hello world 40</textarea>
					<br>
	
					</div>
				语音识别结果显示：
				<br>
				
                <textarea rows="1"  id="echo-form" readonly="true" style=" width: 100%;height:100%" ></textarea>
				<textarea rows="1"  id="varArea" readonly="true" style=" width: 100%;height:100%" ></textarea>
                <textarea rows="1"  id="message" readonly="true" style=" width: 100%;height:100%" ></textarea>
				<br>
				<div class="option">
				<input id="use-stun" type="checkbox"/>
				<label for="use-stun">Use STUN server</label>
				</div>
                <div id="info_div">请点击开始</div>
				<div class="div_class_buttons">
					<button id="btnConnect">连接</button>
					<button id="startLive" onclick="startLive()">数字人加载中</button>
					<button id="btnInfer" onclick="inferStart()">推理</button>
					<button id="btnStart">录音</button>
					<button id="btnStop">停止录音</button>
					<button id="btnInferStop" onclick="inferStop()">退出</button>
 
				</div>
				<div id="media">
					<h2>Media</h2>
					<audio id="audio_record" type="audio/wav" controls style="margin-top: 12px; width: 100%;"></audio>
					<audio id="audio" autoplay="true"></audio>
					<audio id="local_audio" autoplay="false"></audio>
					<video id="video" style="width:600px;" autoplay="true" playsinline="true"></video>
				</div>



			</div>
		</div>

 		<script src="wsconnecter.js" charset="utf-8"></script>
		<script src="main.js" charset="utf-8"></script>
		<!-- <script src="client.js"></script> -->
		<script type="text/javascript" src="http://cdn.sockjs.org/sockjs-0.3.4.js"></script>
		<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" charset="utf-8"></script>
		<script>

        

function negotiate() {
    pc.addTransceiver('video', { direction: 'recvonly' });
    pc.addTransceiver('audio', { direction: 'recvonly' });
    return pc.createOffer().then((offer) => {
        // 修改默认编解码方式
        return pc.setLocalDescription(offer);
    }).then(() => {
        // wait for ICE gathering to complete
        let codecs = RTCRtpSender.getCapabilities('video').codecs;
        console.log(codecs);
        let audio_codecs = RTCRtpSender.getCapabilities('audio').codecs;
        console.log(audio_codecs);
        return new Promise((resolve) => {
            if (pc.iceGatheringState === 'complete') {
                resolve();
            } else {
                const checkState = () => {
                    if (pc.iceGatheringState === 'complete') {
                        pc.removeEventListener('icegatheringstatechange', checkState);
                        resolve();
                    }
                };
                pc.addEventListener('icegatheringstatechange', checkState);
            }
        });
    }).then(() => {
        var offer = pc.localDescription;
        console.log("offer to room_id ",room_id)
        return fetch('/offer', {
            body: JSON.stringify({
                sdp: offer.sdp,
                type: offer.type,
                room_id: room_id,
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            method: 'POST'
        });
    }).then((response) => {
        return response.json();
    }).then((answer) => {
        console.log(answer)
        return pc.setRemoteDescription(answer);
    }).catch((e) => {
        alert(e);
    });
}

function inferStart() {
    var config = {
        sdpSemantics: 'unified-plan'
    };

    if (document.getElementById('use-stun').checked) {
        config.iceServers = [{ urls: ['stun:stun.l.google.com:19302'] }];
    }

    pc = new RTCPeerConnection(config);
    // rtcInboundRtpStreamStats = new RTCInboundRtpStreamStats()
    
    // connect audio / video
    let mediaRecorder;
    let recordedChunks = [];

    // 监听 'track' 事件
    pc.addEventListener('track', (evt) => {
        if (evt.track.kind == 'video') {
            console.log("VIDEO")
            console.log(new Date().toLocaleString())
            // console.log(evt.streams[0])
            console.log(pc.getStats())
            document.getElementById('video').srcObject = evt.streams[0];
        } else {
            // 获取音频流
            console.log("AUDIO")
            console.log(new Date().toLocaleString())
            document.getElementById('audio').srcObject = evt.streams[0];
            let stream = evt.streams[0];
            
            // 创建一个 MediaRecorder 对象来录制音频
            mediaRecorder = new MediaRecorder(stream);
            
            // 当有数据可用时，将数据保存到 recordedChunks 数组中
            mediaRecorder.ondataavailable = function(e) {
                recordedChunks.push(e.data);
            };
            
            // 当录制停止时，保存音频文件
            mediaRecorder.onstop = function() {
                // 合并所有录制的数据
                let recordedBlob = new Blob(recordedChunks, { type: 'audio/wav' });
                
                // 创建一个 URL 对象，用于下载录制的 WAV 文件
                let url = URL.createObjectURL(recordedBlob);
                
                // 创建一个 <a> 元素，用于下载
                let a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'recorded.wav';
                document.body.appendChild(a);
                
                // 点击下载链接
                a.click();
                
                // 释放对象 URL
                window.URL.revokeObjectURL(url);
            };
            
            // 开始录制
            mediaRecorder.start();
            
            // 在这里可以添加逻辑来停止录制 
        }
    });
    // pc.addEventListener('track', (evt) => {
    //     if (evt.track.kind == 'video') {
    //         document.getElementById('video').srcObject = evt.streams[0];
    //     } else {
    //         document.getElementById('audio').srcObject = evt.streams[0];
    //     }
    // });


    document.getElementById('btnInfer').style.display = 'inline-block';
    negotiate();
    document.getElementById('btnInferStop').style.display = 'inline-block';
}

function inferStop() {
    document.getElementById('btnInferStop').style.display = 'inline-block';

    // close peer connection
    setTimeout(() => {
        console.log("stop all.")
        // stop()
        if (pc != null)
            pc.close();
        if (mediaRecorder != null)
            mediaRecorder.stop();
    }, 500);
}

function startLive() {
    console.log("数字人服务启动中")
    fetch('/start_live', {
            body: JSON.stringify({
            }),
            headers: {
                'Content-Type': 'application/json'
            },
            method: 'POST'
        }).then((response) => response.json())
        .then(data => {
            room_id = data.room_id; // 获取 live_id
            console.log("room_id is ",room_id); // 打印 live_id
    })
    .catch(error => {
        console.error('Error:', error);
    });; 
    }
</script>		

				
	</body>
</html>
